<head>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
#start {
    font-size: 200px;
}

#cards-container {
    background-color: white;
    display: flex;
    height: 100%;
    justify-content: space-around;
}

.card {
    align-items: center;
    display: flex;
    flex-basis: 100%;
    flex-grow: 1;
    justify-content: center;
    margin: 50px;
}

.selected {
    border: 15px solid black;
    color: black;
}

img {
    object-fit: cover;
}
</style>
</head>

<div id="content-container">
    <button id="start" onclick="start()">Start</button>
    <div id="cards-container">
        <button class="card" onclick="selected(0);"><img /></button>
        <button class="card" onclick="selected(1);"><img /></button>
        <audio id="audio"></audio>
    </div>
    <div id="reward-container">
        <div id="reward"></div>
    </div>
</div>

<script>
// Hide everything.
const $cardsContainer = $('#cards-container');
const $cards = $('.card');
const $start = $('#start');
const $rewardContainer = $('#reward-container');
const $audio = $('#audio');
const audio = $audio.get(0);

$start.hide();
$cardsContainer.hide();
$rewardContainer.hide();

// Load player. Once loaded, show Start button.
let player;
function onYouTubeIframeAPIReady() {
    $start.show();
    player = new YT.Player('reward', {
        height: window.screen.height,
        playerVars: {
            controls: 0,
            modestbranding: 1,
            rel: 0,
        },
        videoId: 'isidNk0Ppkw',
        width: window.screen.width,
    });
}

// Start button clicked.
function start() {
    $start.hide();

    // Randomize deck.
    shuffle(deck);

    $('#content-container').get(0).requestFullscreen();
    giveCards();
}

// Generate cards and prompt.
const deck = [
    {
        src: 'mom.png',
        prompt: 'select_mom',
        explanation: 'you_selected_mom',
    },
    {
        src: 'dad.jpg',
        prompt: 'select_dad',
        explanation: 'you_selected_dad',
    },
    {
        src: 'bus.png',
        prompt: 'select_bus',
        explanation: 'you_selected_bus',
    },
    {
        src: 'ram.png',
        prompt: 'select_ram',
        explanation: 'you_selected_ram',
    },
    {
        src: 'fan.png',
        prompt: 'select_fan',
        explanation: 'you_selected_fan',
    },
    {
        src: 'sub.png',
        prompt: 'select_sub',
        explanation: 'you_selected_sub',
    },
    {
        src: 'bulb.png',
        prompt: 'select_bulb',
        explanation: 'you_selected_bulb',
    },
    {
        src: 'nun.png',
        prompt: 'select_nun',
        explanation: 'you_selected_nun',
    },
];
let question = null;
let previousCorrect = true;
function giveCards() {
    $cardsContainer.show();
    $rewardContainer.hide();
    $cards.prop('disabled', false).removeClass('selected');

    // Pick question from slide deck.
    if (previousCorrect) {
        question = deck.splice(0, 2);
        deck.push(...question);
        question.forEach(item => {
            item.correct = false
        });

        const correctIndex = Math.floor(Math.random() * 2);
        question[correctIndex].correct = true;
    }
    else {
        // If wrong, give previously expected card + new incorrect card.
        question = question.filter(({ correct }) => correct);

        const next = deck.shift();

        next.correct = false;
        deck.push(next);
        question.push(next);
        shuffle(question);
    }

    // Show cards and give prompt.
    question.forEach(({ src }, index) => {
        $cards.eq(index).find('img').attr('src', `content/${src}`);
    });
    $audio.attr('src', `content/${question.find(({ correct }) => correct).prompt}.m4a`);
    audio.play();
}

// Handle card selection.
function selected(cardIndex) {
    $cards.prop('disabled', true);
    $cards.eq(cardIndex).addClass('selected');

    previousCorrect = question[cardIndex].correct;

    if (previousCorrect) {
        $cardsContainer.hide();
        $rewardContainer.show();
        player.playVideo();
        setTimeout(() => {
            player.pauseVideo();
            giveCards();
        }, 10000);
    }
    else {
        const { explanation } = question.find(({ correct }) => !correct);

        $audio.attr('src', `content/${explanation}.m4a`);
        audio.play();

        new Promise(resolve => audioResolve = resolve).then(() => setTimeout(giveCards, 2000));
    }
}

let audioResolve = null;
audio.onended = () => {
    audioResolve && audioResolve();
};

function shuffle(array) {
    let currentIndex = array.length;
    let temporaryValue;
    let randomIndex;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
    }

    return array;
}
</script>