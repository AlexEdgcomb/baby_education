<head>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
#start {
    font-size: 200px;
}

#cards-container {
    background-color: white;
    display: flex;
    height: 100%;
    justify-content: space-around;
}

.card {
    align-items: center;
    display: flex;
    flex-grow: 1;
    justify-content: center;
    margin: 50px;
}

.selected {
    border: 15px solid black;
    color: black;
}

.text {
    font-size: 100px;
}
</style>
</head>

<div id="content-container">
    <button id="start" onclick="start()">Start</button>
    <div id="cards-container">
        <button class="card" onclick="selected(0);"><span class="text"></span></button>
        <button class="card" onclick="selected(1);"><span class="text"></span></button>
        <audio id="audio"></audio>
    </div>
    <div id="reward-container">
        <div id="reward"></div>
    </div>
</div>

<script>
// Hide everything.
const $cardsContainer = $('#cards-container');
const $cards = $('.card');
const $start = $('#start');
const $rewardContainer = $('#reward-container');
const $audio = $('#audio');
const audio = $audio.get(0);

$start.hide();
$cardsContainer.hide();
$rewardContainer.hide();

// Load player. Once loaded, show Start button.
let player;
function onYouTubeIframeAPIReady() {
    $start.show();
    player = new YT.Player('reward', {
        height: window.screen.height,
        playerVars: {
            controls: 0,
            modestbranding: 1,
            rel: 0,
        },
        videoId: 'isidNk0Ppkw',
        width: window.screen.width,
    });
}

// Start button clicked.
function start() {
    $start.hide();
    $('#content-container').get(0).requestFullscreen();
    giveCards();
}

// Generate cards and prompt.
let question = [
    {
        text: 'MOM',
        correct: true,
        prompt: 'select_mom',
        explanation: 'you_selected_mom',
    },
    {
        text: 'DAD',
        correct: false,
        prompt: 'select_dad',
        explanation: 'you_selected_dad',
    },
];
function giveCards() {
    $cardsContainer.show();
    $rewardContainer.hide();
    $cards.prop('disabled', false).removeClass('selected');

    // TODO: Pick images from slide deck.

    // Randomize content shown.
    shuffle(question);

    const correctIndex = Math.floor(Math.random() * 2);

    question.forEach(item => {
        item.correct = false
    });
    question[correctIndex].correct = true;

    // Show cards and give prompt.
    $cards.eq(0).find('span').text(question[0].text);
    $cards.eq(1).find('span').text(question[1].text);
    $audio.attr('src', `content/${question[correctIndex].prompt}.m4a`);
    audio.play();
}

// Handle card selection.
function selected(cardIndex) {
    $cards.prop('disabled', true);
    $cards.eq(cardIndex).addClass('selected');

    if (question[cardIndex].correct) {
        $cardsContainer.hide();
        $rewardContainer.show();
        player.playVideo();
        setTimeout(() => {
            player.pauseVideo();
            giveCards();
        }, 10000);
    }
    else {
        const wrongOne = question.find(item => !item.correct);

        $audio.attr('src', `content/${wrongOne.explanation}.m4a`);
        audio.play();

        const promise = new Promise(resolve => {
            audioResolve = resolve;
        });
        promise.then(giveCards);
    }
}

let audioResolve = null;
audio.onended = () => {
    audioResolve && audioResolve();
};

function shuffle(array) {
    let currentIndex = array.length;
    let temporaryValue;
    let randomIndex;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
    }

    return array;
}
</script>